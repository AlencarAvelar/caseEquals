<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Equals - Relatório Completo (Homologação)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Configuração da Barra de Rolagem e Tabela */
        .table-responsive {
            max-height: 700px; /* Altura máxima vertical */
            overflow-y: auto;
            overflow-x: auto;  /* Barra de rolagem horizontal */
            border: 1px solid #dee2e6;
        }

        /* Cabeçalho Fixo */
        thead th {
            position: sticky;
            top: 0;
            background-color: #0d6efd;
            color: white;
            z-index: 10;
            white-space: nowrap; /* Não quebra linha no cabeçalho */
            font-size: 0.85rem;
            text-align: center;
            vertical-align: middle;
        }

        /* Células da Tabela */
        td {
            white-space: nowrap; /* Força a tabela a crescer horizontalmente */
            font-size: 0.8rem;
            vertical-align: middle;
            padding: 4px 8px !important; /* Mais compacto */
        }

        /* Estilos específicos */
        .money { text-align: right; font-weight: bold; color: #198754; }
        .tax { text-align: right; color: #dc3545; }
        .id-col { background-color: #e9ecef; font-weight: bold; }

        .success-msg { color: green; font-weight: bold; margin-top: 10px; }
        .error-msg { color: red; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <h3 class="mb-4">Desafio Equals - Homologação de Arquivo </h3>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">1. Upload do Arquivo</h5>
            <form id="uploadForm" class="row g-3 align-items-center">
                <div class="col-auto">
                    <input type="file" class="form-control" id="fileInput" accept=".txt" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-success">Processar Arquivo</button>
                </div>
                <div class="col-auto">
                    <span id="uploadStatus"></span>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title m-0">2. Relatório</h5>
                <div class="d-flex gap-2 align-items-center">
                    <label>Filtro de Data:</label>
                    <input type="date" id="dataInicio" class="form-control form-control-sm">
                    <span>até</span>
                    <input type="date" id="dataFim" class="form-control form-control-sm">
                    <button onclick="carregarVendas()" class="btn btn-primary btn-sm">Filtrar</button>



                    <label class="ms-2">Bandeira:</label>
                    <select id="filtroBandeira" class="form-select form-select-sm" style="width: 150px;">
                        <option value="">Todas</option>
                        <option value="MASTERCARD">Mastercard</option>
                        <option value="VISA">Visa</option>
                    </select>

                    <button onclick="carregarVendas()" class="btn btn-primary btn-sm">Filtrar</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered table-sm">
                    <thead class="table-dark">
                    <tr>
                        <th colspan="3" class="bg-secondary">Identificação</th>
                        <th colspan="4" class="bg-secondary">Datas e Horas</th>
                        <th colspan="4" class="bg-secondary">Financeiro (Valores)</th>
                        <th colspan="7" class="bg-secondary">Taxas e Tarifas</th>
                        <th colspan="4" class="bg-secondary">Parcelamento</th>
                        <th colspan="5" class="bg-secondary">Detalhes Técnicos</th>
                        <th colspan="7" class="bg-secondary">Captura e Cartão</th>
                    </tr>
                    <tr>
                        <th>ID Banco</th>
                        <th>Loja</th>
                        <th>NSU</th>

                        <th>Dt. Transação</th>
                        <th>Dt. Evento</th>
                        <th>Hora</th>
                        <th>Prev. Pagto</th>

                        <th>Vlr. Total</th>
                        <th>Vlr. Líquido</th>
                        <th>Vlr. Original</th>
                        <th>Vlr. Líq Trans</th>

                        <th>Tx Parc Comp</th>
                        <th>Tar Bol Comp</th>
                        <th>Tx Parc Vend</th>
                        <th>Tx Intermed</th>
                        <th>Tar Intermed</th>
                        <th>Tar Bol Vend</th>
                        <th>Repasse App</th>

                        <th>Ind. Pagto</th>
                        <th>Plano</th>
                        <th>Parc</th>
                        <th>Qtd</th>

                        <th>Tp Evento</th>
                        <th>Tp Trans</th>
                        <th>Série Leitor</th>
                        <th>Cód Trans</th>
                        <th>Cód Pedido</th>

                        <th>Status</th>
                        <th>Meio Pagto</th>
                        <th>Bandeira</th>
                        <th>Canal</th>
                        <th>Leitor</th>
                        <th>Captura</th>
                        <th>Num Lógico</th>
                        <th>Bin</th>
                        <th>Holder</th>
                        <th>Auth</th>
                        <th>CV</th>
                    </tr>
                    </thead>
                    <tbody id="tabelaVendas">
                    </tbody>
                </table>
            </div>
            <div class="mt-2 text-muted small">
                * Utilize a barra de rolagem horizontal para ver todas as 40+ colunas.
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/transactions';

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('uploadStatus');

        if(fileInput.files.length === 0) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        statusDiv.innerHTML = "Processando...";
        statusDiv.className = "";

        try {
            const response = await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
            if (response.ok) {
                statusDiv.innerText = "Sucesso!";
                statusDiv.className = "success-msg";
                carregarVendas();
            } else {
                const text = await response.text();
                statusDiv.innerText = "Erro: " + text;
                statusDiv.className = "error-msg";
            }
        } catch (error) {
            statusDiv.innerText = "Erro de conexão.";
            statusDiv.className = "error-msg";
        }
    });

    async function carregarVendas() {
        const inicio = document.getElementById('dataInicio').value;
        const fim = document.getElementById('dataFim').value;
        const bandeira = document.getElementById('filtroBandeira').value; // <--- Pega o valor

        // Monta a URL com Query Params dinamicamente
        const params = new URLSearchParams();
        if (inicio) params.append('inicio', inicio);
        if (fim) params.append('fim', fim);
        if (bandeira) params.append('bandeira', bandeira); // <--- Adiciona na URL

        // A URL final será algo como: /api/transactions?inicio=...&bandeira=VISA
        const url = `${API_URL}?${params.toString()}`;

        try {
            const response = await fetch(url);
            const transactions = await response.json();
            const tbody = document.getElementById('tabelaVendas');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="45" class="text-center p-4">Nenhum registro encontrado para os filtros selecionados.</td></tr>';
                return;
            }

            transactions.forEach(t => {

                const row = `<tr>
                    <td class="id-col">${t.id}</td>
                    <td>${t.estabelecimento}</td>
                    <td>${t.nsu}</td>
                    <td>${t.dataTransacao}</td>
                    <td>${t.dataEvento}</td>
                    <td>${t.horaEvento}</td>
                    <td>${t.dataPrevistaPagamento}</td>
                    <td class="money">${t.valorTotal}</td>
                    <td class="money">${t.valorLiquido}</td>
                    <td class="money">${t.valorOriginal}</td>
                    <td class="money">${t.valorLiquidoTransacao}</td>
                    <td class="tax">${t.taxaParcelamentoComprador}</td>
                    <td class="tax">${t.tarifaBoletoComprador}</td>
                    <td class="tax">${t.taxaParcelamentoVendedor}</td>
                    <td class="tax">${t.taxaIntermediacao}</td>
                    <td class="tax">${t.tarifaIntermediacao}</td>
                    <td class="tax">${t.tarifaBoletoVendedor}</td>
                    <td class="tax">${t.repasseAplicacao}</td>
                    <td>${t.indicadorPagamento}</td>
                    <td>${t.plano}</td>
                    <td>${t.parcela}</td>
                    <td>${t.qtdParcelas}</td>
                    <td>${t.tipoEvento}</td>
                    <td>${t.tipoTransacao}</td>
                    <td>${t.numeroSerieLeitor}</td>
                    <td>${t.codigoTransacao}</td>
                    <td>${t.codigoPedido}</td>
                    <td>${t.statusPagamento}</td>
                    <td>${t.meioPagamento}</td>
                    <td><strong>${t.bandeira}</strong></td>
                    <td>${t.canalEntrada}</td>
                    <td>${t.leitor}</td>
                    <td>${t.meioCaptura}</td>
                    <td>${t.numeroLogico}</td>
                    <td>${t.cartaoBin}</td>
                    <td>${t.cartaoHolder}</td>
                    <td>${t.codigoAutorizacao}</td>
                    <td>${t.codigoCV}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error(error);
            alert("Erro ao buscar dados.");
        }
    }

    // Carregar inicial
    carregarVendas();
</script>

</body>
</html>